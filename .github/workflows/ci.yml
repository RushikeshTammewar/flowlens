name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.flowlens.in

  backend:
    name: Backend
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            backend/requirements.txt
            agent/requirements.txt

      - name: Install dependencies
        run: pip install -r backend/requirements.txt -r agent/requirements.txt

      - name: Syntax check (all Python files)
        run: python -c "
          import ast, pathlib, sys
          failed = False
          for f in sorted(pathlib.Path('.').rglob('*.py')):
              if '.venv' in str(f) or 'node_modules' in str(f):
                  continue
              try:
                  ast.parse(f.read_text())
              except SyntaxError as e:
                  print(f'FAIL: {f} - {e}'); failed = True
          if failed: sys.exit(1)
          print('All Python files parsed OK')
          "

      - name: Import check
        run: python -c "
          from agent.models.graph import SiteGraph, SiteNode, PageElement, ActionResult
          from agent.models.types import BugFinding, PageMetrics, CrawlResult
          from agent.models.flow import Flow, FlowStep, ConditionalStep, FlowResult, FlowStepResult
          from agent.models.context import FlowContext
          from agent.core.ai_engine import GeminiEngine
          from agent.core.explorer import SiteExplorer
          from agent.core.scanner import FlowLensScanner
          from agent.core.flow_runner import FlowRunner
          from agent.core.flow_planner import identify_flows
          from agent.utils.form_filler import identify_fields, fill_form
          from agent.utils.element_finder import find_element, find_form
          from agent.utils.auth_handler import AuthHandler, AuthResult
          from agent.utils.smart_wait import wait_for_stable_page, install_request_tracker
          from agent.utils.retry_engine import find_with_retry
          from agent.utils.popup_guard import dismiss_overlays
          from agent.utils.state_verifier import StateVerifier
          from agent.utils.test_data import detect_site_type, get_search_query, get_form_data
          print('All imports OK')
          "
